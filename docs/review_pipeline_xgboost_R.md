# review_pipeline_xgboost.R

## Purpose
This script performs a quick inspection and validation of all artifacts generated by the full XGBoost pipeline. It checks that:
1. The **states lookup** (`states_lookup.rds`) has the expected number of rows (40 for an 8×5 grid).
2. The **events with assigned states** (`events_states.rds`) exists and its `state_id` values fall within `[1, 40]`.
3. The **plays dataset** (`plays.rds`) contains the columns `start_state` and `end_state`, and that their values are within `[1, 40]`.
4. The trained **XGBoost model** (`xgb_dest_model.rds`) loads correctly with `num_class = 40`.
5. The **inferred plays** (`plays_dest.rds`) has the same number of rows as `plays.rds`, includes a new column `dest_probs` of length 40 for each play, and each probability vector sums to 1.
6. The **aggregated transition counts** (`trans_counts_agg.rds`) has a reasonable number of rows (at most 40×40 = 1,600) and shows the first `(origin_state, dest_state)` pairs with their weights.

---

## Dependencies

- **R packages**:
  - `here` (for relative paths)
  - `dplyr` (for minimal data manipulation)
- **Required files** (must exist in `data/derived/` and `models/`):
  1. `data/derived/states_lookup.rds`
  2. `data/derived/events_states.rds`
  3. `data/derived/plays.rds`
  4. `models/xgb_dest_model.rds`
  5. `data/derived/plays_dest.rds`
  6. `data/derived/trans_counts_agg.rds`

---

## Inputs
1. **`states_lookup.rds`**  
   - Location: `data/derived/states_lookup.rds`  
   - Description: Data frame of all 40 states in the 8×5 grid.  
   - Key columns:  
     - `state_id` (1–40)  
     - `x_bin`, `y_bin`, `x_mid`, `y_mid`, `lane`

2. **`events_states.rds`**  
   - Location: `data/derived/events_states.rds`  
   - Description: Every event from `events_clean.rds` with an assigned `state_id`.  
   - Key columns:  
     - All original `events_clean` columns  
     - `state_id` (1–40)

3. **`plays.rds`**  
   - Location: `data/derived/plays.rds`  
   - Description: Data frame of “plays” (passes) with new columns:  
     - `start_state` (1–40)  
     - `end_state` (1–40 or NA)  
     - `transition_flag` (logical)  
   - Note: It retains all original event columns, many of which will be `NA`.

4. **`xgb_dest_model.rds`**  
   - Location: `models/xgb_dest_model.rds`  
   - Description: Trained XGBoost model for predicting `end_state` across 40 classes.  
   - Should have parameter `num_class = 40`.

5. **`plays_dest.rds`**  
   - Location: `data/derived/plays_dest.rds`  
   - Description: Each row (play) from `plays.rds` plus a column `dest_probs`, a list of 40 probabilities summing to 1.

6. **`trans_counts_agg.rds`**  
   - Location: `data/derived/trans_counts_agg.rds`  
   - Description: Aggregated transition weights for each `(origin_state, dest_state)` pair, with columns:  
     - `origin_state` (integer 1–40)  
     - `dest_state` (integer 1–40)  
     - `total_weight` (sum of probabilities for that pair across all plays)